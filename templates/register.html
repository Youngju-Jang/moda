<!doctype html>
<html lang="en">
<head>


    <title>Hello, world!</title>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script>
        function changePhone1() {
            const phone1 = document.getElementById("phone1").value // 010
            if (phone1.length === 3) {
                document.getElementById("phone2").focus();
            }
        }

        function changePhone2() {
            const phone2 = document.getElementById("phone2").value // 010
            if (phone2.length === 4) {
                document.getElementById("phone3").focus();
            }
        }

        function changePhone3() {
            const phone3 = document.getElementById("phone3").value // 010
            if (phone3.length === 4) {
                document.getElementById("sendMessage").focus();
                document.getElementById("sendMessage").setAttribute("style", "background-color:yellow;")
                document.getElementById("sendMessage").disabled = false;
            }
        }

        // 문자인증+타이머 부분
        function initButton() {
            document.getElementById("sendMessage").disabled = true;
            document.getElementById("completion").disabled = true;
            document.getElementById("certificationNumber").innerHTML = "000000";
            document.getElementById("timeLimit").innerHTML = "03:00";
            document.getElementById("sendMessage").setAttribute("style", "background-color:none;")
            document.getElementById("completion").setAttribute("style", "background-color:none;")
        }

        let processID = -1;

        const getToken = () => {

            // 인증확인 버튼 활성화
            document.getElementById("completion").setAttribute("style", "background-color:yellow;")
            document.getElementById("completion").disabled = false;

            if (processID != -1) clearInterval(processID);
            const token = String(Math.floor(Math.random() * 1000000)).padStart(6, "0");
            document.getElementById("certificationNumber").innerText = token;
            let time = 180;
            processID = setInterval(function () {
                if (time < 0 || document.getElementById("sendMessage").disabled) {
                    clearInterval(processID);
                    initButton();
                    return;
                }
                let mm = String(Math.floor(time / 60)).padStart(2, "0");
                let ss = String(time % 60).padStart(2, "0");
                let result = mm + ":" + ss;
                document.getElementById("timeLimit").innerText = result;
                time--;
            }, 50);
        };

        function checkCompletion() {
            alert("문자 인증이 완료되었습니다.")
            initButton();
            document.getElementById("completion").innerHTML = "인증완료"
            document.getElementById("signUpButton").disabled = false;
            document.getElementById("signUpButton").setAttribute("style", "background-color:yellow;")
        }

        function register() {
            $.ajax({
                type: "POST",
                url: "/api/register",
                data: {
                    id_give: $('#userid').val(),
                    pw_give: $('#userpw').val(),
                    nickname_give: $('#usernick').val()
                },
                success: function (response) {
                    if (response['result'] == 'success') {
                        alert('회원가입이 완료되었습니다.')
                        window.location.href = '/login'
                    } else {
                        alert(response['msg'])
                    }
                }
            })
        }

        $(function () {
            $("#alert-success").hide();
            $("#alert-danger").hide();
            $("input").keyup(function () {
                var userpw = $("#userpw").val();
                var chkpw = $("#chkpw").val();
                if (userpw != "" || chkpw != "") {
                    if (userpw == chkpw) {
                        $("#alert-success").show();
                        $("#alert-danger").hide();
                        $("#submit").removeAttr("disabled");
                    } else {
                        $("#alert-success").hide();
                        $("#alert-danger").show();
                        $("#submit").Attr("disabled", "disabled");
                    }
                }
            });
        });


    </script>
    <style>
        .input {
            width: 30%;
            height: 50%;
        }
    </style>
</head>
<body>

<div class="section has-text-centered">
    <h1 class="title" style="color: black">sign in</h1>
    <div>
        <input type="text" class="input" id="userid" name="id" aria-describedby="emailHelp"
           placeholder="사용하실 ID를 입력해주세요" maxlength="12">
    </div>
    <div class="section has-text-centered">
        <input type="password" class="input" id="userpw" name="pw1"
               placeholder="사용하실 PW를 입력해주세요" required/>
    </div>
    <div class="section has-text-centered">
        <input type="password" class="input" id="chkpw" name="pw2"
               placeholder="사용하실 PW를 확인해주세요" required/>
        <div class="alert alert-success" id="alert-success">비밀번호가 일치합니다</div>
        <div class="alert alert-danger" id="alert-danger">비밀번호가 일치하지 않습니다</div>
    </div>
    <div class="section has-text-centered">
        <input type="text" class="input" id="usernick" placeholder="사용하실 닉네임을 입력해주세요">
    </div>
    <div class="gender">
        <input id="gender_man" type="radio" name="gender">남성
        <input id="gender_woman" type="radio" name="gender">여성
        <div id="genderError" class="error"></div>
    </div>
    <div class="phone">
        <input id="phone1" type="text" size="1" maxlength="3" oninput="changePhone1()"> -
        <input id="phone2" type="text" size="3" maxlength="4" oninput="changePhone2()"> -
        <input id="phone3" type="text" size="3" maxlength="4" oninput="changePhone3()">
    </div>
    <div class="auth">
        <div id="certificationNumber">000000</div>
        <button disabled id="sendMessage" onclick="getToken()">인증번호 전송</button>
    </div>
    <div class="timer">
        <div id="timeLimit">03:00</div>
        <button disabled id="completion" onclick="checkCompletion()">인증확인</button>
    </div>
    <div>
        <button type="submit" class="button is-primary" onclick="register()">회원가입</button>
    </div>
</div>

</body>
</html>

